<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">


<head>
  <title></title>
  <link type="text/css" rel="stylesheet" href="Css/ChatStyle.css" />
  <link rel="stylesheet" href="/Css/JQueryUI/themes/base/jquery.ui.all.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  <style>
    @font-face {
      font-family: 'LCD';
      src: url('/css/Fonts/LCD_Solid.eot?#iefix') format('embedded-opentype'),
           url('/css/Fonts/LCD_Solid.woff2') format('woff2'),
           url('/css/Fonts/LCD_Solid.woff') format('woff'),
           url('/css/Fonts/LCD_Solid.svg#lcd_solidregular') format('svg');
      src: url('/css/Fonts/LCD_Solid.eot');
      font-weight: normal;
      font-style: normal;
    }
    .joined, 
    .join, 
    .start, 
    .playing,
    .members { float:right; display: none; font-size: 10px; cursor: pointer; }
    .memberGroup {  position: relative; }
    ul.memberContainer { list-style: none; position: absolute; left: 215px; top: -20px; border: solid #000 1px; padding: 0; }
    ul.memberContainer li{ padding: 5px 20px; width:100%; }
    #divSplash, 
    #divGame, 
    #divResults { font-family: LCD; position: absolute; top: 0; height: 100vh; width: 100vw; text-align: center; background-color: #00B400; }
    #divSplash *, 
    #divGame *, 
    #divResults *, 
    #divChat *,   
    #divLogin *,    
    #header{ font-family: LCD;  }
        #divSplash .container, 
        #divResults .container { transform: translateY(50%); }
    .resultsContainer table { margin:auto; }
        .resultsContainer * { font-size: 24px; }
        .resultsContainer tr th { width: 140px; padding-bottom: 12px;   }
    .button { font-family: LCD; background-color: #FFF; font-size: 24px; }
    .red { color: #f00; }
    .privateWindow * { font-family: LCD; font-size: 14px; }
    #divChat { position: relative; }
    p.message { position: absolute; bottom: -20px; margin: 0; font-size: 12px; padding-bottom: 5px }

  </style>
    

  <!--Script references. -->
  <script src="/Scripts/jquery-1.8.2.js"></script><!--<script src="/Scripts/jquery-1.6.4.min.js"></script>-->
  <script src="/Scripts/ui/jquery.ui.core.js"></script>
  <script src="/Scripts/ui/jquery.ui.widget.js"></script>
  <script src="/Scripts/ui/jquery.ui.mouse.js"></script>
  <script src="/Scripts/ui/jquery.ui.draggable.js"></script>
  <script src="/Scripts/ui/jquery.ui.resizable.js"></script>
   
  <script src="/Scripts/jquery.signalR-2.2.0.js"></script><!--Reference the SignalR library. -->
  <script src="/signalr/hubs"></script><!--Reference the autogenerated SignalR hub script. -->
    

  <script type="text/javascript">
     
    // ---------------------------  CLIENT OBJECTS ------------------------------------------------

    // -------------- PROGRAM Class -------------- 
    //Holds general data needed to be persisted
    function Program() {
        this.groups = {};
        this.currentUser;
        this.currentPage = "none";
        this.allUsersConnected = null;
    }

    // -------------- USER Class -------------- 
    //User Information for this user
        //TODO: could be persisted with cookies 
    function User() {
        this.id;
        this.name;
        this.persistedId;
    }

    // -------------- GROUP Class -------------- 
    //contains all the info for groups, should be synced with the server data
    function Group() {
        this.id;
        this.object;
        this.cachedIndex;
    }

    // ----------END--------------  CLIENT OBJECTS ---------------------END------------------------





    // -----------  ----------- CHAT ROOM KEY FUNCTIONS -----------  ----------- 

    $(function () {

        setScreen("waiting"); //until user details retreived
        console.log("waiting");

        // GLOBAL Declare a proxy to reference the hub.
        chatHub = $.connection.chatHub; 
        registerClientMethods();
        // Start Hub
        $.connection.hub.start().done(function () {
          console.log("CONNECTION START");
          registerEvents();
          connectionManagement();
        });

        $.connection.hub.reconnected(function () {
          console.log("reconnected!");
          registerEvents();
          connectionManagement();
        });

        //have to log off and on again
        $.connection.hub.reconnecting(function () {
          console.log("reconnecting!");
          //  //http://www.asp.net/signalr/overview/guide-to-the-api/handling-connection-lifetime-events
          //  //http://www.asp.net/signalr/overview/guide-to-the-api/mapping-users-to-connections
          //  //chatHub.stop();
          
        });

    });



    //may add further details in future to this if needed to access DB etc
    function addUserDetailsToCookie(userName, connectionId, persistedId) {
      var cookieName = "chatRoomUserDetails";
      var expieryInDays = 4;
      var jsonObjString = "{  \"userName\": \"" + userName + "\",  \"connectionId\": \"" + connectionId + "\",  \"persistedId\": \"" + persistedId + "\"    }";
      setCookie(cookieName, jsonObjString, expieryInDays);
    }
    

    function setCookie(cname, cvalue, exdays) {
      var d = new Date();
      d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
      var expires = "expires=" + d.toUTCString();
      document.cookie = cname + "=" + cvalue + "; " + expires;
    }

    function getCookie(cname) {
      var name = cname + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }



    function setScreen(screen) {  //screen handler
        $("#divChat").hide();
        $("#divLogin").hide();
        $("#header").hide();
        $("#divSplash").hide();
        $("#divGame").hide();
        $("#divResults").hide();
        switch (screen) {
            case "waiting":
                $("#header").show();
                break
            case "login":
              program.currentPage = "login";
                $("#header").show();
                $("#divLogin").show();
                break;
            case "chat":
                program.currentPage = "chat";
                $("#header").show();
                $("#divChat").show();

                chatHub.server.updateClientGroups();
                break;
            case "splash":
                program.currentPage = "splash";
                keyFlashing();
                $("#divSplash").show();
                break;
            case "game":
                program.currentPage = "game";
                canvasGame();
                $("#divGame").show();
                break;
            case "results":
                program.currentPage = "results";
                $("#divResults").show();
                console.log("user.id : ", user.id);
                $(".backToChat").on("click tap", function () {
                    location.reload();
                });
                break;
          default:
              $("#header").show();
              break;
        }
    }

    //Makes keys on splash screen flash
    function keyFlashing() {
        keyFlash = setInterval(function () {
            $(".instructions .g").toggleClass("red");
            $(".instructions .h").toggleClass("red");

        }, 500);
        setTimeout(function () {
            $(".instructions .g").removeClass("red");
            $(".instructions .h").removeClass("red");
            clearTimeout(keyFlash);
        }, 15000);
    }

    function registerEvents() {
      $("#btnStartChat").click(function () {
        var name = $("#txtNickName").val();
        var connectionId = $.connection.hub.id;
        if (name.length > 0) {
          chatHub.server.login(name, connectionId);
        }
        else {
          alert("Please enter name");
        }
      });
      $('#btnSendMsg').click(function () {
        var msg = $("#txtMessage").val();
        if (msg.length > 0) {
          var userName = $('#hdUserName').val();
          chatHub.server.sendMessageToAll(userName, msg);
          $("#txtMessage").val('');
        }
      });
      $('#btnAddGroup').click(function () {
        chatHub.server.addGroup(   $("#hdId").val()  );
      });
      $("#txtNickName").keypress(function (e) {
        if (e.which == 13) {
          $("#btnStartChat").click();
        }
      });
      $("#txtMessage").keypress(function (e) {
        if (e.which == 13) {
          $('#btnSendMsg').click();
        }
      });
    }


    function removeDuplicateUsers() {
      //console.log("----- removeDuplicateUsers(); ------");

      //remove duplicate .user id
      var users = [];
      $(".user").each(function () {
        $user = $(this);
        var currentId = $(this).attr("id")
        var counter = 0;
        $("#" + currentId).each(function () {
          if (counter > 0) {
            console.log("duplicate id : "+currentId + "  ->  removed");
            $(this).remove();
          }
        });
      });

      //remove loginUser duplicates
      var loginUsers = [];
      $(".loginUser").each(function () {
        var loginUser = $(this);
        loginUsers.push(loginUser);
      });
      for (var i in loginUsers) {
        if (i > 0) {
          loginUsers[i].remove();
          console.log("duplicate .loginUser removed")
        }
      }

    }



    //Attempts to retreive User Details from Cookie (possibly extended to retreive details from DB as well :¬D )
    function connectionManagement() {
     
      var connectionId = $.connection.hub.id;

      // ----- INITIALISE -----
      program = new Program();
      user = new User();
      user.id = connectionId;
      group = new Group();


      var cookieName = "chatRoomUserDetails";
      if (getCookie(cookieName) == "") {
        setScreen("login"); //login screen needs to set cookie
      }
      else {
        console.log("Attempting to Retreive COOKIE!!!");
        //Connect to server retreived cookie details
        var cookieObj = JSON.parse(getCookie(cookieName)); //check if cookie, if so then retreive and use that user name
        // has following fields: cookieObj.userName   cookieObj.connectionId  cookieObj.persistedId
        console.log("cookieObj : ", cookieObj);
        chatHub.server.connect(cookieObj.persistedId, connectionId, cookieObj.userName);
      }

    }


    function registerClientMethods() {

        // Calls when user successfully logged in
      chatHub.client.onLoggedIn = function (id, userName, persistedId, allUsers, messages) {
          addUserDetailsToCookie(userName, id, persistedId)
          console.log("connectionId : ", id, ", persistedId : ", persistedId, ",   userName : ", userName, " , allUsers :  ", allUsers, " ,  messages : ", messages);
          user.name = userName;
          user.persistedId = persistedId;
          setScreen("chat");
          //update DOM user info entry
          $('#hdId').val(id);
          $('#hdUserName').val(userName);
          $('#spanUser').html(userName);
          chatHub.server.updateClientGroups();

          // Add All Users
          for (i = 0; i < allUsers.length; i++) {
              AddUser( allUsers[i].ConnectionId, allUsers[i].UserName);
          }
          // Add Existing Messages
          for (i = 0; i < messages.length; i++) {
              AddMessage(messages[i].UserName, messages[i].Message);
          }
          updateUsersList(allUsers);
        }

        //user replies to poll to register presence
        chatHub.client.pollUserCheck = function (pollId) {
          chatHub.server.pollUserUpdate(user.id, pollId, user.persistedId);
        }


        //Updates users online list - replaced onNewUserConnected and onUserDisconnected
        chatHub.client.updateUsersList = function (connectedUsers) {
          updateUsersList(connectedUsers);
        }


        //updates online users list with object from server
        function updateUsersList(newConnectedUsers){
          if (program.allUsersConnected == null) { 
            program.allUsersConnected = newConnectedUsers; //set if note instantiated
          }
          else {

            //set new added augmented property as false
            for (i in newConnectedUsers) {
              newConnectedUsers[i]["inPreviousUsersConnected"] = false;
            }

            //loop through users in new list, 
            for (i in program.allUsersConnected) {
              var isCurrentInNew = false;
              var tempJ = 0;
              for (j in newConnectedUsers) {
                // does old id exist
                if (newConnectedUsers[j].ConnectionId == program.allUsersConnected[i].ConnectionId ) {
                  isCurrentInNew = true;
                  newConnectedUsers[j]["inPreviousUsersConnected"] = true;
                  tempJ = j;
                }
              }
              if (!isCurrentInNew) {
                //ADD TO REMOVE ID LIST
                console.log("User has logged off : ", program.allUsersConnected[i]);
                var id = program.allUsersConnected[i].ConnectionId;
                var userName = program.allUsersConnected[i].UserName;
                userDisconnection(id, userName);
              }

            }

            for (i in newConnectedUsers) {
              if (newConnectedUsers[i]["inPreviousUsersConnected"] == false) {
                AddUser(newConnectedUsers[i].ConnectionId, newConnectedUsers[i].UserName);
              }
            }
            program.allUsersConnected = newConnectedUsers; //update users at end

          }

          removeDuplicateUsers();
        }

        //updates message sent
        chatHub.client.messageReceived = function (userName, message) {
            AddMessage(userName, message);
        }



        //will update client information related to whom is in which group
        chatHub.client.updateGroupInfo = function (groupInfoArrayIn) {
            var groupInfoArray = JSON.parse(groupInfoArrayIn);

            
            for (i in groupInfoArray){ //loop groups
                for (j in groupInfoArray[i].users) { //loop users in group
                    var adminId = groupInfoArray[i].adminId;
                    var userId = groupInfoArray[i].users[j].ConnectionId;
                    var userName = groupInfoArray[i].users[j].UserName;
                    var isGroupAdmin = false;
                    isGroupAdmin = user.id == adminId ? true : false;
                    if (isGroupAdmin) {
                        $(".loginUser .start").show();
                        $(".loginUser .members").show();
                        $("#btnAddGroup").hide();
                        var membersObj = groupInfoArray[i].users;
                        $(".loginUser .members").data("membersObject", membersObj);
                        $(".loginUser .start").data("group-id", groupInfoArray[i].id);
                        group.id = groupInfoArray[i].id;
                        group.object = groupInfoArray[i];
                    }
                    else {
                        //are we in adminID loop iteration
                        if (adminId == userId) {
                            $("#" + userId).find(".join").show();
                        }
                        //are we dealing with this user in this loop iteration     
                        if (user.id == userId) {
                            //sets values on the this group (info for this user)
                            group.id = groupInfoArray[i].id;
                            group.object = groupInfoArray[i];
                            //shows that user has joined this group
                            $("#" + adminId).find(".join").hide();
                            $("#" + adminId).find(".joined").show();
                        }

                        if (groupInfoArray[i].users[j].Status == 1) { //Status = 1 -> 'OnSplash' 
                            console.log("Status is 'playing'");
                            $("#" + userId).find(".playing").show();
                            $("#" + adminId).find(".join").hide();
                            $("#" + adminId).find(".joined").hide();
                        }
                    }


                }//j
            }//i

            updateAdminGroupDetails();
        }

        //Private message opens a private message window for idividual chat
        chatHub.client.sendPrivateMessage = function (windowId, fromUserName, message) {
            var ctrId = 'private_' + windowId;
            if ($('#' + ctrId).length == 0) {
                createPrivateChatWindow( windowId, ctrId, fromUserName);
            }
            $('#' + ctrId).find('#divMessage').append('<div class="message"><span class="userName">' + fromUserName + '</span>: ' + message + '</div>');
            // set scrollbar
            var height = $('#' + ctrId).find('#divMessage')[0].scrollHeight;
            $('#' + ctrId).find('#divMessage').scrollTop(height);
        }

        //Show splash screen
        chatHub.client.showSplash = function () {
            $(".readyButton").show();
            $(".waiting").hide();
            setScreen("splash");

            $(".readyButton").on("click", function ()
            {
                //looks through all players in group, if all ready then go to next screen
                chatHub.server.playerReady(user.id, group.id );
                $(".readyButton").hide();
                $(".waiting").show();
            });
        }


        chatHub.client.removeFromChatRoom = function (persistedId) {
          if (user.persistedId == persistedId) {
            console.log("Remove from chatroom as user.persistedId : " + user.persistedId + " == persistedId : " + persistedId + " )");
            window.location.href = "/logged-off.html";
          }
        }

        // ----- GAME FUNCTIONS -----
        
        //show game screen
        chatHub.client.showGameScreen = function () {
            setScreen("game");
            canvasGame();
        }

        chatHub.client.updateCountdown = function (time) {
            game.countdownTime = parseInt(time);
        }

        chatHub.client.clientEndGame = function (listOPlayers) {
            game.endGame(listOPlayers);
        }
        

        chatHub.client.updateGame = function (listOPlayers) {
            for (i in game.players) {
                game.players[i].syncObject = listOPlayers.PlayerStates[game.players[i].id];
            }
        }

        chatHub.client.clientError = function (heading, message) {
          var text = "------------ " + heading + " ----------------\n\n";
          text += message;
          alert(text);
        }


    } //registerClientMethods()



    // Will show list of people in group for admin group
    function updateAdminGroupDetails() {
        var members = $(".members").data("membersObject");
        var membersHtml = "<ul class='memberContainer'>";
        for (i in members) {
            if (i == 0) {
                membersHtml += "<li  data-id='" + members[i].ConnectionId + "'>MEMBERS:</li>"; //HACK to show members lable
            }
            membersHtml += "<li data-id='" + members[i].ConnectionId + "' >" + members[i].UserName + "</li>";
        }
        membersHtml += "</ul>";
        $(".memberGroup").html(membersHtml);
    }

    //Add user to users list 
    function AddUser( id, name) {
        var userId = $('#hdId').val();
        var code = "";
        if (userId == id) {
            code = $('<div class="loginUser">' + name + " <a class='members'>&nbsp;</a><a class='start'>&nbsp;start&nbsp;</a><span class='memberGroup'></span></div>"); //members&nbsp;
            $(code).find(".members").on("click tap", function () {
                updateAdminGroupDetails();
            });
            $(code).find(".start").on("click tap", function () {
                var groupID = $(this).data("group-id");
                var a = chatHub.server.signalStartGame(groupID); //HACK : requires calling twice for some reason
                console.log(a);
                chatHub.server.signalStartGame(groupID);
            });
        }
        else {
            code = $('<a id="' + id + '" class="user" >' + name + "<span class='join'>&nbsp;join&nbsp;</span><span class='joined'>&nbsp;joined&nbsp;</span><span class='playing'>&nbsp;playing&nbsp;</span><a></div>");
            $(code).dblclick(function () {
                var id = $(this).attr('id');
                if (userId != id)
                    OpenPrivateChatWindow( id, name);
            });
            $(code).find(".join").on("click", function () {
                //Not Group ID but is the admin for that group, can get group using C# Group.getAdminId() 
                var adminID = id;
                //add the user to group addUserToGroup(user, adminID);
                chatHub.server.addUserToGroup(user.id, adminID);
            });
        }
        $("#divusers").append(code);
    }


    //update UI to reflect user loggin off
    function userDisconnection(id, userName) {
      console.log("onUserDisconnected --> id  : ", id, ", userName  : ", userName);
      $('#' + id).remove();
      var ctrId = 'private_' + id;
      $('#' + ctrId).remove();
      var disc = $('<div class="disconnect">"' + userName + '" logged off.</div>');
      $(disc).hide();
      $('#divusers').prepend(disc);
      $(disc).fadeIn(200).delay(2000).fadeOut(200);
    }


    function AddMessage(userName, message) {
      $('#divChatWindow').append('<div class="message"><span class="userName">' + userName + '</span>: ' + message + '</div>');
      var height = $('#divChatWindow')[0].scrollHeight;
      $('#divChatWindow').scrollTop(height);
    }




    // -----------  ----------- PRIVATE CHAT -----------  ----------- 

    function OpenPrivateChatWindow( id, userName) {
        var ctrId = 'private_' + id;
        if ($('#' + ctrId).length > 0) return;
        createPrivateChatWindow( id, ctrId, userName);
    }

    function createPrivateChatWindow( userId, ctrId, userName) {
        var div = '<div id="' + ctrId + '" class="ui-widget-content draggable privateWindow" rel="0">' +
                    '<div class="header">' +
                        '<div  style="float:right;">' +
                            '<img id="imgDelete"  style="cursor:pointer;" src="/Images/delete.png"/>' +
                        '</div>' +

                        '<span class="selText" rel="0">' + userName + '</span>' +
                    '</div>' +
                    '<div id="divMessage" class="messageArea">' +

                    '</div>' +
                    '<div class="buttonBar">' +
                        '<input id="txtPrivateMessage" class="msgText" type="text"   />' +
                        '<input id="btnSendMessage" class="submitButton button" type="button" value="Send"   />' +
                    '</div>' +
                '</div>';

        var $div = $(div);
        // DELETE BUTTON IMAGE
        $div.find('#imgDelete').click(function () {
            $('#' + ctrId).remove();
        });
        // Send Button event
        $div.find("#btnSendMessage").click(function () {
            $textBox = $div.find("#txtPrivateMessage");
            var msg = $textBox.val();
            if (msg.length > 0) {
                chatHub.server.sendPrivateMessage(userId, msg);
                $textBox.val('');
            }
        });
        // Text Box event
        $div.find("#txtPrivateMessage").keypress(function (e) {
            if (e.which == 13) {
                $div.find("#btnSendMessage").click();
            }
        });
        AddDivToContainer($div);
    }

    function AddDivToContainer($div) {
        $('#divContainer').prepend($div);
        $div.draggable({
            handle: ".header",
            stop: function () {

            }
        });
    }





    // -----------  ----------- CANVAS GAME -----------  ----------- 

    //not in global scope, watch the scope of variables
    function canvasGame() {
        

        // -----------  GAME OBJECTS ----------- 

        function canvasObj(X, Y, Width, Height, path) {
            //position
            this.x = X;
            this.y = Y;
            //dimensions
            this.imgWidth = Width;
            this.imgHeight = Height;
            //image object
            this.imageObj = new Image();
            this.imageObj.src = path;
        }

        function GameObject() {
            this.totalPresses = 200;
            this.trackDistancePixels = 800; //calculated
            this.speedRefreshPerSec = 10;
            this.players = [];
            this.thisPlayer = {};
            this.startPixelX = 50;
            this.finishPosition = [];

            this.screenUpdateMs = 50;   
            this.uploadUpdateMS = 500;  
            this.countdownTime = 5;

            this.stopWatch = 0;        
            this.timerlock = true;
            this.endGame = function (playerStates) { endGameSequence(playerStates); }
            
        }

        function Player(inName, inId) {
            this.name = inName;
            this.id = inId;
            this.canvasObject;
            this.distancePresses = 0;
            this.sentFinishedSignal = false;
            this.startTime;
            this.syncObject = { //object synced with server
                "userId": inId,
                "groupId": group.id, 
                "distancePresses": 0,
                "finishTimeMs": 0,
            }
            this.increment = function () {
                if (this.hasFinishedRace()) { return; } //console.log("hasFinishedRace = TRUE");
                this.syncObject.distancePresses++;
            }
            this.hasFinishedRace = function () {
                if (this.syncObject.distancePresses > game.totalPresses) {
                    return true;
                }
                else {
                    return false;
                }
                //return this.syncObject.distancePresses > game.totalPresses ? true : false;
            }
            this.hasSentFinished = function () {
                //console.log("this.hasSentFinished : ", this.sentFinishedSignal);
                return this.sentFinishedSignal;
            }
        }



        // -----------  GAME INIT ----------- 

        var canvas = document.getElementById('myCanvas');
        var c = canvas.getContext('2d');
        //var canary = []; //CANvas ARraY
        var staticCanary = []; //static CANvas ARraY

        //static objects
        crowd1 = new canvasObj(0, 0, 300, 200, 'Images/tiled-crowd.png');
        crowd2 = new canvasObj(300, 0, 300, 200, 'Images/tiled-crowd.png');
        crowd3 = new canvasObj(600, 0, 300, 200, 'Images/tiled-crowd.png');
        crowd4 = new canvasObj(900, 0, 300, 200, 'Images/tiled-crowd.png');

        board1 = new canvasObj(50, 180, 300, 40, 'Images/pds-board.png');
        board2 = new canvasObj(350, 180, 300, 40, 'Images/pds-board.png');
        board3 = new canvasObj(650, 180, 300, 40, 'Images/pds-board.png');
        board4 = new canvasObj(950, 180, 300, 40, 'Images/pds-board.png');

        line1 = new canvasObj(100, 220, 950, 5, 'Images/line.png');
        line2 = new canvasObj(100, 350, 950, 5, 'Images/line.png');
        line3 = new canvasObj(100, 480, 950, 5, 'Images/line.png');
        line4 = new canvasObj(100, 610, 950, 5, 'Images/line.png');
        line5 = new canvasObj(100, 740, 950, 5, 'Images/line.png');
        line6 = new canvasObj(200, 220, 10, 525, 'Images/line.png');
        line7 = new canvasObj(1000, 220, 10, 525, 'Images/line.png');

        staticCanary.push(crowd1);
        staticCanary.push(crowd2);
        staticCanary.push(crowd3);
        staticCanary.push(crowd4);
        staticCanary.push(board1);
        staticCanary.push(board2);
        staticCanary.push(board3);
        staticCanary.push(board4);

        staticCanary.push(line1);
        staticCanary.push(line2);
        staticCanary.push(line3);
        staticCanary.push(line4);
        staticCanary.push(line5);
        staticCanary.push(line6);
        staticCanary.push(line7);
        //moving objects 

        // update other players 
        game = new GameObject(); //singleton - dont make anoter!
        var yCoords = [260, 390, 520, 650];

        
        for (i in group.object.users) { //testobject.users
            if (group.object.users[i].ConnectionId == user.id) {
                var player = new Player(group.object.users[i].UserName, group.object.users[i].ConnectionId);
                game.thisPlayer = player;
            }
            var player = new Player(group.object.users[i].UserName, group.object.users[i].ConnectionId);
            player.canvasObject = new canvasObj( game.startPixelX , yCoords[i], 125, 125, 'Images/pixel-runner.png');
            game.players.push(player);
        }

        //Will update periodicly based on this.screenUpdateMs & this.uploadUpdateMS e.g =1000
        draw();
        uploadData();
       



        // -----------  GAME FUNCTIONS ----------- 

        var player_keys = [71, 72]; // g & h
        var index = 0;
        document.body.addEventListener('keydown', function (e) {
            //player_keys
            if (e.keyCode == player_keys[index] && !game.timerlock) {
                game.thisPlayer.increment();
                index = changeI(index);
            }
        });

        function changeI(index) {
            return a = index == 0 ? 1 : 0;
        }

        //upload 'syncObject' object to server 
        function uploadData() {   
            if (program.currentPage != "game") { return; }
            chatHub.server.uploadData(game.thisPlayer.syncObject);
            setTimeout(uploadData, game.uploadUpdateMS);
        }


        
        //For initial startoff countdown and stopwatch
        function countdown() {
            var caption = game.countdownTime.toString(); //countdownTime updated from server
            //leave this
            c.fillStyle = '#FFF';
            c.font = "120px LCD";
            c.fillText(caption, 500, 470);
        }
        
        function stopWatchUpdate() {
            if (game.timerlock) {
                game.timerlock = false;
                game.thisPlayer.startTime = new Date().getTime();
                //console.log("this.startTime - before : ", game.thisPlayer.startTime);
            }
            //stop watch needs to be ran according to clients system clock 
            var dateTimeMS = new Date().getTime();
            var msSinceStart = dateTimeMS - game.thisPlayer.startTime;
            //console.log("msSinceStart : ", msSinceStart);
            c.font = "50px LCD";
            c.fillText((msSinceStart / 1000).toFixed(1).toString(), 450, 790);
        }


        //Screen refresh every 0.1 secs OR 100ms 
        function draw() {
            //c.clearRect(); //TODO: clear this
            c.fillStyle = '#00B400'; //fill entire grid with white
            c.fillRect(0, 0, canvas.width, canvas.height);
            preperationTasks();
            generatedStatic();
            if (program.currentPage == "game") {
                if (game.countdownTime <= 0) {
                    stopWatchUpdate();
                }
                else {
                    countdown();
                }
            }
            drawImgs();
            setTimeout(draw, game.screenUpdateMs);
        }
		

        function preperationTasks() {
            for (i in game.players) {
                //update canvas with presses position
                var addDistance = game.trackDistancePixels / (game.totalPresses / game.players[i].syncObject.distancePresses);
                newDistance = game.players[i].canvasObject.x + addDistance;
                game.players[i].canvasObject.x = game.startPixelX + addDistance; // 50 is start distance
            }

            //check if the race is finished
            if (game.thisPlayer.hasFinishedRace() && !game.thisPlayer.hasSentFinished()) {  //&& game.thisPlayer.raceComplete == false
                var dateTimeMS = new Date().getTime();
                var msSinceStart =  dateTimeMS - game.thisPlayer.startTime;
                //console.log("dateTimeMS : ", dateTimeMS, " - type : ", (typeof dateTimeMS), " , game.startTime : ", game.thisPlayer.startTime, " - type : ", (typeof game.thisPlayer.startTime));
                game.thisPlayer.syncObject.finishTimeMs = msSinceStart;
                chatHub.server.endGame(game.thisPlayer.syncObject);
                game.thisPlayer.sentFinishedSignal = true; //send the endgame message to the server ONCES
            }

        }
  


        function endGameSequence(playerStates) {
            var html = "<table>";
            html += "<tr><th>POSITION</th><th>NAME</th><th>TIME</th></tr>"; //
            for(i in playerStates){
                var finishTimeSecs = (playerStates[i].Value.finishTimeMs/1000).toFixed(1);
                var userId = playerStates[i].Value.userId;
                var pos = parseInt(i) + 1;
                var name = "";
                //get names from id
                for(j in game.players){
                    if(game.players[j].id == userId){
                        name = game.players[j].name;
                        break
                    }
                }
                html += "<tr><td>" + pos + "</td><td>" + name + "</td><td>" + finishTimeSecs + "</td></tr>";
            }
            html += "</table>"
            $(".resultsContainer").html(html);
            setScreen("results");
        }


        function drawImgs(){
            //iterate array and draw each image
            for (i in staticCanary) {
                drawObj(staticCanary[i]);
            }
            for(i in game.players){
                drawObj( game.players[i].canvasObject );
            }
        }

        function drawObj(canObj){
            var centerX = canObj.x - (canObj.imageObj.width / 2);
            var centerY = canObj.y -  (canObj.imageObj.height / 2);
            c.drawImage(canObj.imageObj, centerX, centerY, canObj.imgWidth, canObj.imgHeight );
        }

        function generatedStatic() {
            c.fillStyle = '#FFF';
            c.font = "30px LCD";
            for (i in game.players) {
                c.fillText(game.players[i].name, 160, ( yCoords[i] + 30 ) );
            }
        }

        


    }// ---- END CanvasGame() ----


  </script>
    
</head>

<body>
    <div id="header">
        Running Simulator 2000 Chat Room
    </div>
    <br />
    <br />
    <br />

    <div id="divContainer">

        <div id="divLogin" class="login">
            <div>
                Your Name:<br />
            <input id="txtNickName" type="text" class="textBox" />
            </div>
            <div id="divButton">
                <input id="btnStartChat" type="button" class="submitButton" value="Start Chat" />
            </div>
        </div>

        <div id="divChat" class="chatRoom">
            <div class="title">
                Welcome to the Chat Room: <span id='spanUser'></span>

            </div>
            <div class="content">
                <div id="divChatWindow" class="chatWindow">
                </div>
                <div id="divusers" class="users">
                </div>
            </div>
            <div class="messageBar">
                <input class="textbox" type="text" id="txtMessage" />
                <input id="btnSendMsg" type="button" value="Send" class="submitButton" />
                <input id="btnAddGroup" type="button" value="+ Group" class="addGroupButton" />
            </div>
            <p class="message">*Double click on user to start private chat window</p>
        </div>

        <input id="hdId" type="hidden" />
        <input id="hdUserName" type="hidden" />


        <div id="divSplash" >
            <div class="container">
                <h1>Welcome to Running Simulator 2000</h1><br>
                <h2>Bought to you by Pro:Direct</h2><br>
                <br><br><br>
                <p class="instructions"><strong>Instructions: </strong> Just press <span class="g red">'g'</span> then <span class="h">'h'</span> keys as fast as you can!</p>
                <br><br>
                <button class="readyButton button">Click When Ready!</button>
                <p class="waiting">Waiting for other players...</p>
                <br><br>
                <p>Developed by<br> the North Korean Technology Board<br> and David Hannaford</p>
            </div>
        </div>


        <div id="divGame" >
            <div class="container">
                <h1>Running Simulator 2000</h1>
                
                <canvas id="myCanvas" width="1024" height="800" style="border:1px solid #d3d3d3;">
                    Your browser does not support the HTML5 canvas tag.
                </canvas>

            </div>
        </div>

        <div id="divResults">
            <div class="container">
                <h1>Results</h1>
                <br><br>
                <div class="resultsContainer"></div>
                <br><br>
                <button class="backToChat button">Back to Chat Room</button>
                <br><br>
            </div>
        </div>

    </div>

</body>
</html>


<!-- 
    FUTURE IMPROVEMENTS:
    *) ****insert here****

     @font-face { 
        font-family: 'LCD'; 
        src:  
            /*url('/css/fonts/DINLightAlternate.svg#Din') format('svg'),  Legacy iOS*/ 
            /*url('/css/fonts/DINLightAlternate.eot?#iefix') format('embedded-opentype'),  IE6-IE8 */
            /*url('/css/fonts/DINLightAlternate.woff2') format('woff2'),  Super Modern Browsers */
            /*url('/css/fonts/DINLightAlternate.woff') format('woff'),  Pretty Modern Browsers */
            url('/css/Fonts/LCD_Solid.ttf')  format('truetype'); /*PTS55F.ttf Safari, Android, iOS */
        font-weight: normal; 
        font-style: normal;
    }
--> 